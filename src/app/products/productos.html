<div class="main-wrapper">
  <!-- Encabezado -->
  <div class="top-header">
    <button class="menu-button" (click)="toggleMenu()">
      <span class="material-symbols-outlined">dehaze</span>
    </button>
    <h1>Gesti√≥n de Productos</h1>
    <div class="search-container">
      <div class="search-box">
        <span class="search-icon" *ngIf="!busqueda">üîç</span>
        <input 
          type="text" 
          placeholder="Buscar Producto" 
          [(ngModel)]="busqueda"
          class="search-input"
        >
      </div>
      <button class="filter-button" (click)="toggleFiltro()">
        <span class="material-icons">filter_list</span>
      </button>
    </div>
  </div>

  <!-- Men√∫ lateral -->
  <div class="sidebar-menu" [class.open]="menuAbierto">
    <div class="menu-header">
      <h2>Men√∫</h2>
      <button class="close-button" (click)="toggleMenu()">‚úï</button>
    </div>
    <nav class="menu-nav">
  <a routerLink="/main" class="menu-item">
    <span class="material-icons">inventory_2</span>
    Stock General
  </a>
  <a routerLink="/productos" class="menu-item active">
    <span class="material-icons">shopping_cart</span>
    Productos
  </a>
  <a routerLink="/proveedores" class="menu-item">
    <span class="material-icons">local_shipping</span>
    Proveedores
  </a>
  <a routerLink="/clientes" class="menu-item">
    <span class="material-icons">people</span>
    Clientes
  </a>
  <a routerLink="/cotizaciones" class="menu-item">
    <span class="material-icons">description</span>
    Cotizaciones
  </a>
  <a routerLink="/configuracion" class="menu-item">
    <span class="material-icons">settings</span>
    Configuraci√≥n
  </a>
  <a routerLink="/login" class="menu-item logout">
    <span class="material-icons">logout</span>
    Cerrar Sesi√≥n
  </a>
</nav>
  </div>

  <!-- Overlay del men√∫ -->
  <div class="menu-overlay" *ngIf="menuAbierto" (click)="toggleMenu()"></div>

  <!-- Men√∫ de filtros -->
  <div class="filter-menu" *ngIf="mostrarFiltro">
    <h3>Filtrar por:</h3>
    <label>
      <input type="radio" [(ngModel)]="filtroSeleccionado" value="todos" name="filtro">
      Todos los campos
    </label>
    <label>
      <input type="radio" [(ngModel)]="filtroSeleccionado" value="codigo" name="filtro">
      C√≥digo de Barras
    </label>
    <label>
      <input type="radio" [(ngModel)]="filtroSeleccionado" value="nombre" name="filtro">
      Nombre del Producto
    </label>
    <label>
      <input type="radio" [(ngModel)]="filtroSeleccionado" value="proveedor" name="filtro">
      Proveedor
    </label>
  </div>

  <!-- Contenido principal -->
  <div class="content-area">
    <!-- Bot√≥n agregar -->
    <div class="action-bar">
      <button class="btn-primary" (click)="abrirModalAgregar()">
        <span class="material-icons">add</span>
        Agregar Producto
      </button>
    </div>

    <!-- Indicador de carga -->
    <div *ngIf="isLoading()" class="loading-indicator">
      <p>Cargando productos...</p>
    </div>

    <!-- Tabla de productos -->
    <div class="table-container" *ngIf="!isLoading()">
      <div class="table-wrapper">
        <table>
        <thead>
          <tr>
            <th>Imagen</th>
            <th>C√≥digo</th>
            <th>Nombre</th>
            <th>Caracter√≠sticas</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Proveedor</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let producto of filtrarProductos()">
            <td>
              <img 
                [src]="producto.imagen || 'https://via.placeholder.com/60x60?text=Sin+Imagen'" 
                alt="Producto"
                class="product-image"
                onerror="this.src='https://via.placeholder.com/60x60?text=Error'"
              >
            </td>
            <td>{{ producto.codigo }}</td>
            <td>{{ producto.nombre }}</td>
            <td>{{ producto.caracteristicas }}</td>
            <td>${{ producto.precio.toLocaleString('es-MX', {minimumFractionDigits: 2}) }}</td>
            <td>{{ producto.stock }}</td>
            <td>{{ producto.proveedor }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-edit" (click)="abrirModalEditar(producto)" title="Editar">
                  <span class="material-icons">edit</span>
                </button>
                <button class="btn-delete" (click)="confirmarEliminar(producto.id)" title="Eliminar">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="filtrarProductos().length === 0">
            <td colspan="8" style="text-align: center; padding: 40px; color: white;">
              No se encontraron productos
            </td>
          </tr>
        </tbody>
      </table>
    </div>
   </div> 
  </div>

  <!-- MODAL AGREGAR/EDITAR -->
  @if (showModal()) {
    <div class="modal-overlay-centered">
      <div class="modal-content-large">
        <div class="modal-header">
          <h2>{{ modoEdicion() ? 'Editar Producto' : 'Agregar Producto' }}</h2>
          <button class="close-button" (click)="intentarCerrarModal()" type="button">‚úï</button>
        </div>

        <form class="product-form" (ngSubmit)="guardarProducto()">
          <div class="form-row">
            <div class="form-group">
              <label>Nombre *</label>
              <input 
                type="text" 
                [(ngModel)]="productoActual.nombre" 
                name="nombre"
                placeholder="Ej: Microscopio Compuesto"
                required
              >
            </div>

            <div class="form-group">
              <label>C√≥digo *</label>
              <input 
                type="text" 
                [(ngModel)]="productoActual.codigo" 
                name="codigo"
                placeholder="Ej: 7501234567890"
                required
              >
            </div>
          </div>

          <div class="form-group">
            <label>Caracter√≠sticas</label>
            <textarea 
              [(ngModel)]="productoActual.caracteristicas" 
              name="caracteristicas"
              placeholder="Ej: √ìptico binocular 1000x LED"
              rows="3"
            ></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Precio *</label>
              <input 
                type="number" 
                [(ngModel)]="productoActual.precio" 
                name="precio"
                placeholder="0.00"
                min="0"
                step="0.01"
                required
              >
            </div>

            <div class="form-group">
              <label>Stock *</label>
              <input 
                type="number" 
                [(ngModel)]="productoActual.stock" 
                name="stock"
                placeholder="0"
                min="0"
                required
              >
            </div>
          </div>

          <div class="form-group">
            <label>Proveedor</label>
            <input 
              type="text" 
              [(ngModel)]="productoActual.proveedor" 
              name="proveedor"
              placeholder="Ej: LabTech M√©xico"
            >
          </div>

          <div class="form-group">
            <label>Imagen del Producto</label>
            <div class="image-option-selector">
              <label class="radio-option">
                <input 
                  type="radio" 
                  [(ngModel)]="opcionImagen" 
                  value="url" 
                  name="opcionImagen"
                >
                URL de imagen
              </label>
              <label class="radio-option">
                <input 
                  type="radio" 
                  [(ngModel)]="opcionImagen" 
                  value="archivo" 
                  name="opcionImagen"
                >
                Subir archivo
              </label>
            </div>

            <input 
              *ngIf="opcionImagen === 'url'"
              type="url" 
              [(ngModel)]="productoActual.imagen" 
              name="imagenUrl"
              placeholder="https://ejemplo.com/imagen.jpg"
            >

            <input 
              *ngIf="opcionImagen === 'archivo'"
              type="file" 
              accept="image/*"
              (change)="onImagenArchivoSeleccionado($event)"
              class="file-input"
            >

            <div *ngIf="productoActual.imagen" class="image-preview">
              <img [src]="productoActual.imagen" alt="Vista previa">
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="intentarCerrarModal()">
              Cancelar
            </button>
            <button type="submit" class="btn-primary" [disabled]="isLoading()">
              {{ isLoading() ? 'Guardando...' : (modoEdicion() ? 'Actualizar' : 'Guardar') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- MODAL CONFIRMAR CERRAR SIN GUARDAR -->
  @if (showConfirmCloseModal()) {
    <div class="modal-overlay-centered" style="z-index: 1100;">
      <div class="modal-content-warning">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h3>¬øDescartar cambios?</h3>
        <p>Tienes cambios sin guardar. Si cierras ahora, se perder√°n todos los datos ingresados.</p>
        <div class="modal-actions">
          <button class="btn-secondary" (click)="cancelarCerrar()">Continuar editando</button>
          <button class="btn-danger" (click)="confirmarCerrarSinGuardar()">Descartar cambios</button>
        </div>
      </div>
    </div>
  }

  <!-- MODAL CONFIRMAR ELIMINACI√ìN -->
  @if (showConfirmModal()) {
    <div class="modal-overlay-centered">
      <div class="modal-content-warning">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h3>Confirmar eliminaci√≥n</h3>
        <p>¬øEst√°s seguro de que deseas eliminar este producto? Esta acci√≥n no se puede deshacer.</p>
        <div class="modal-actions">
          <button class="btn-secondary" (click)="cancelarEliminar()">Cancelar</button>
          <button class="btn-danger" (click)="eliminarProducto()" [disabled]="isLoading()">
            {{ isLoading() ? 'Eliminando...' : 'Eliminar' }}
          </button>
        </div>
      </div>
    </div>
  }
</div>
